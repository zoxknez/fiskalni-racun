# Deployment Guide

Kompletno uputstvo za deployment Fiskalni Raƒçun aplikacije.

## üöÄ Platforms

### Vercel (Recommended)

Najbr≈æi i najlak≈°i naƒçin za deployment:

```bash
# Install Vercel CLI
npm i -g vercel

# Deploy
vercel

# Production deployment
vercel --prod
```

**Environment Variables:**
- `VITE_SUPABASE_URL`
- `VITE_SUPABASE_ANON_KEY`
- `VITE_POSTHOG_KEY` (optional)
- `VITE_SENTRY_DSN` (optional)

**Auto-deployment:**
- Push to `main` ‚Üí Production
- Push to other branches ‚Üí Preview

### Netlify

```bash
# Install Netlify CLI
npm i -g netlify-cli

# Deploy
netlify deploy

# Production
netlify deploy --prod
```

**Build settings:**
- Build command: `npm run build`
- Publish directory: `dist`

### Docker

```bash
# Build image
docker build -t fiskalni-racun .

# Run container
docker run -p 80:80 fiskalni-racun

# Or use docker-compose
docker-compose up -d
```

### Self-hosted (Nginx)

```bash
# Build production bundle
npm run build

# Copy dist/ to server
scp -r dist/* user@server:/var/www/fiskalni-racun/

# Nginx config is in nginx.conf
# Copy to /etc/nginx/sites-available/fiskalni-racun
```

## üìã Pre-deployment Checklist

### 1. Environment Setup

- [ ] Set all required environment variables
- [ ] Configure Supabase project (production)
- [ ] Set up analytics (PostHog, Vercel Analytics)
- [ ] Configure Sentry error tracking
- [ ] Enable HTTPS/SSL
- [ ] Configure custom domain

### 2. Build Optimization

```bash
# Type check
npm run type-check

# Linting
npm run lint

# Tests
npm run test:run
npm run test:e2e

# Bundle analysis
npm run build:analyze

# Size check
npm run size
```

### 3. Database Setup

```sql
-- Run in Supabase SQL Editor

-- Enable Row Level Security
ALTER TABLE receipts ENABLE ROW LEVEL SECURITY;
ALTER TABLE devices ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_sessions ENABLE ROW LEVEL SECURITY;

-- Policies for receipts
CREATE POLICY "Users can view own receipts"
  ON receipts FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own receipts"
  ON receipts FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own receipts"
  ON receipts FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own receipts"
  ON receipts FOR DELETE
  USING (auth.uid() = user_id);

-- Similar policies for devices and user_sessions
```

### 4. Security Headers

Already configured in `vercel.json` and `nginx.conf`:
- Content Security Policy (CSP)
- HSTS (HTTP Strict Transport Security)
- X-Frame-Options
- X-Content-Type-Options
- Referrer-Policy
- Permissions-Policy

### 5. Performance

- [ ] Enable compression (Brotli + Gzip)
- [ ] Configure caching headers
- [ ] Enable CDN for static assets
- [ ] Optimize images (WebP/AVIF)
- [ ] Enable HTTP/2 or HTTP/3

## üîê Environment Variables

### Required

```bash
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Optional

```bash
# Analytics
VITE_POSTHOG_KEY=phc_xxxxx
VITE_POSTHOG_HOST=https://app.posthog.com

# Error Tracking
VITE_SENTRY_DSN=https://xxxxx@xxxxx.ingest.sentry.io/xxxxx
VITE_SENTRY_ENVIRONMENT=production

# Vercel Analytics (auto-detected)
VITE_VERCEL_ANALYTICS_ID=xxxxx
```

## üìä Monitoring Setup

### Sentry

1. Create account at [sentry.io](https://sentry.io)
2. Create new React project
3. Copy DSN to `VITE_SENTRY_DSN`
4. Deploy
5. Errors automatically tracked

### PostHog

1. Create account at [posthog.com](https://posthog.com)
2. Get API key
3. Set `VITE_POSTHOG_KEY`
4. Events automatically tracked

### Vercel Analytics

- Automatically enabled on Vercel
- Web Vitals tracked
- Real User Monitoring (RUM)

### Lighthouse CI

Configured in `.github/workflows/ci.yml`:
- Runs on every PR
- Performance budgets enforced
- Results in GitHub Actions

## üåç Custom Domain

### Vercel

1. Go to Project Settings ‚Üí Domains
2. Add your domain
3. Configure DNS:
   ```
   Type: CNAME
   Name: www
   Value: cname.vercel-dns.com
   ```

### Netlify

1. Go to Domain Settings
2. Add custom domain
3. Configure DNS:
   ```
   Type: CNAME
   Name: www
   Value: your-site.netlify.app
   ```

## üì± PWA Deployment

### App Store Submission (Optional)

Use **PWABuilder** to create app store packages:

1. Go to [pwabuilder.com](https://www.pwabuilder.com)
2. Enter your PWA URL
3. Download packages for:
   - Google Play Store (Android)
   - Microsoft Store (Windows)
   - App Store (iOS - via wrapper)

### Service Worker

- Automatically generated by `vite-plugin-pwa`
- Precaches all static assets
- Runtime caching for API calls
- Background sync for offline data

## üîÑ CI/CD

### GitHub Actions

Configured in `.github/workflows/ci.yml`:

1. **Code Quality**
   - Lint check
   - Type check
   - Format check

2. **Testing**
   - Unit tests
   - E2E tests
   - Coverage report

3. **Build**
   - Production build
   - Bundle analysis
   - Size check

4. **Deploy**
   - Vercel deployment (auto)
   - Docker image build

5. **Audit**
   - Lighthouse CI
   - Accessibility check
   - Performance budgets

### Manual Deployment

```bash
# Build locally
npm run build

# Test production build
npm run preview

# Deploy to Vercel
vercel --prod

# Deploy via Docker
docker-compose up -d --build
```

## üêõ Troubleshooting

### Build Fails

```bash
# Clear cache
npm run clean
rm -rf node_modules
npm install

# Check for type errors
npm run type-check

# Check for linter errors
npm run lint
```

### Environment Variables Not Working

- Vite requires `VITE_` prefix
- Restart dev server after changing .env
- Check `src/lib/env.ts` for validation

### PWA Not Updating

```bash
# Clear service worker
# In DevTools: Application ‚Üí Service Workers ‚Üí Unregister

# Force update
npm run build
# Deploy and hard refresh (Ctrl+Shift+R)
```

### Supabase Connection Issues

- Check RLS policies are correct
- Verify ANON_KEY is set
- Check CORS settings in Supabase dashboard

## üìà Post-Deployment

### 1. Smoke Testing

- [ ] Sign up / Sign in works
- [ ] Add receipt works
- [ ] Upload image works
- [ ] QR scanning works
- [ ] Export works
- [ ] PWA install works
- [ ] Offline mode works

### 2. Performance Check

```bash
# Run Lighthouse
npm run lighthouse

# Check Web Vitals in production
# Vercel Analytics ‚Üí Web Vitals tab
```

### 3. Error Monitoring

- Check Sentry for errors
- Monitor analytics for drop-offs
- Review Web Vitals

### 4. User Feedback

- Set up feedback form
- Monitor support channels
- Track feature usage (PostHog)

## üîó Resources

- [Vercel Documentation](https://vercel.com/docs)
- [Netlify Documentation](https://docs.netlify.com)
- [Supabase Production Checklist](https://supabase.com/docs/guides/platform/going-into-prod)
- [PWA Best Practices](https://web.dev/pwa-checklist/)
- [Web Vitals](https://web.dev/vitals/)

---

**Happy Deploying! üöÄ**

